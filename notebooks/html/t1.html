{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "\n",
       "<textarea rows=5 id=nav_head_content style=\"width:100%;display:none;\">\n",
       "<style>\n",
       "a.bh,  a.bh:visited, a.bh:link, a.bh:active {\n",
       "  ttext-decoration: none; \n",
       "  color: black;\n",
       "  font-family: 'Roboto','Heebo',Arial,sans-serif;\n",
       "  font-size: 3em\n",
       "}\n",
       "</style>\n",
       "<!--\n",
       "<div id='HTMLTopBar' style=\"    \n",
       "    z-index: 50;\n",
       "    align-items: stretch;\n",
       "    width:100%\">\n",
       "    <div  style=\"\n",
       "        text-color: black;\n",
       "        background-color: #fefefe;\n",
       "        bborder-bottom: 1px dotted gray;\n",
       "        padding-left: 2px;\n",
       "        box-shadow: 5px 1px #ccc;\n",
       "        height: 40px; left: 0; \n",
       "        padding: 14px;\n",
       "        \"\n",
       "    >\n",
       "    <a class=bh1 href=\"#\" onclick=\"$('#maintoolbar').toggle();\">X</a>\n",
       "</div>\n",
       "-->\n",
       "</textarea>\n",
       "\n",
       "<script>\n",
       "if ($('#nav_head').length < 1) {\n",
       "    $('#notebook-container').prepend('<div id=\"nav_head\" style=\"width:100%;\">.</div>')\n",
       "    console.log(\"Added a div\")\n",
       "} else{\n",
       "    console.log(\"Already Added\")    \n",
       "}\n",
       "\n",
       "$('#nav_head').html($('#nav_head_content').val())\n",
       "\n",
       "$('.nbp-app-bar').toggle()\n",
       "</script>\n"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<style>\n",
       "@import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');\n",
       "</style>\n",
       "<style>\n",
       "<link href=\"https://fonts.googleapis.com/css2?family=Roboto&display=swap\" rel=\"stylesheet\">\n",
       "\n",
       "body  p ol li {\n",
       "    font-family: \"Roboto\",  \"Lucida Grande\", \"Lucida Sans Unicode\";\n",
       "    font-size: 14px;\n",
       "    background: #fff\n",
       "}\n",
       "\n",
       "h1, h2, h3{\n",
       "    font-family: 'Roboto', sans-serif;\n",
       "}\n",
       "div#notebook_panel div#notebook{\n",
       "    background: #ffffff\n",
       "}\n",
       "div#notebook-container{\n",
       "    box-shadow: 0px;\n",
       "    padding: 0px;\n",
       "    border-left: .05em dotted gray;\n",
       "    -webkit-box-shadow: 0px;\n",
       "    box-shadow: none;\n",
       "}\n",
       "</style>\n"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<style>\n",
       ".container { width: 100% !important; }\n",
       "    div.cell{\n",
       "        width:100%;\n",
       "        margin-left:0%;\n",
       "        margin-right:auto;\n",
       "}\n",
       ".CodeMirror {\n",
       "    font-family: monospace;\n",
       "}\n",
       "div.input_area {\n",
       "    border: 0px;\n",
       "}\n",
       "div.cell.selected{\n",
       "  border: '0px';\n",
       "}\n",
       ".cell.selected{\n",
       "  border: '0px';\n",
       "}\n",
       "div#notebook{\n",
       "    padding-top: 0px;\n",
       "}\n",
       "div.prompt_container {\n",
       "    display: block; \n",
       "    background: #f7f7f7;\n",
       "}\n",
       "div.prompt{\n",
       "    min-width:0px;\n",
       "    display: grid;\n",
       "}\n",
       "div.cell{\n",
       "    padding-bottom: 5px;\n",
       "    padding-left: 0px;\n",
       "}\n",
       "\n",
       "a.bh,  a.bh:visited, a.bh:link, a.bh:active {\n",
       "  text-decoration: none; \n",
       "  color:white;\n",
       "  font-family: 'Roboto','Heebo',Arial,sans-serif;\n",
       "  font-size:1em\n",
       "}\n",
       "a.bh:hover {\n",
       "  color: #ffccdd;\n",
       "}\n",
       "\n",
       "a.bh1,  a.bh1:visited, a.bh1:link, a.bh1:active {\n",
       "  text-decoration: none; \n",
       "  color: rgba(0, 0, 0, 0.87);\n",
       "  font-family: 'Roboto','Heebo',Arial,sans-serif;\n",
       "  padding-right: 30px;\n",
       "  font-size:1.1em\n",
       "}\n",
       "a.bh1:hover {\n",
       "  color: rgba(0, 0, 0, 0.57);\n",
       "}\n",
       "    \n",
       "#toc-wrapper {\n",
       "   font-family: 'Roboto','Heebo',Arial,sans-serif;\n",
       "    border: 0px dotted gray;\n",
       "    padding: 10px;\n",
       "    line-height: 1.8em;\n",
       "}    \n",
       "</style>\n",
       "<script>\n",
       "l=\"https://www.ancient-symbols.com/images/wp-image-library/fullsize/infinity.jpg\"\n",
       "l=\"imgs/logo.png\"\n",
       "l=\"\"\n",
       "$('#ipython_notebook').html(`<img src=\"${l}\">`)\n",
       "\n",
       "</script>\n"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "#skip\n",
    "%reload_ext autoreload\n",
    "%autoreload 2\n",
    "import colabexts\n",
    "from colabexts.jcommon import *\n",
    "\n",
    "jpath=os.path.dirname(colabexts.__file__)\n",
    "jcom = f'{jpath}/jcommon.ipynb'\n",
    "%run $jcom\n",
    "\n",
    "import os, sys, datetime, re, json, importlib\n",
    "from collections import defaultdict\n",
    "from sys import modules\n",
    "from IPython.display import HTML, Javascript\n",
    "import warnings\n",
    "import pandas as pd\n",
    "warnings.filterwarnings('ignore')\n",
    "\n",
    "%matplotlib inline\n",
    "pd.set_option('display.max_colwidth', 40)\n",
    "pd.set_option('display.max_rows', 16)\n",
    "\n",
    "import importlib as imp\n",
    "import sys, scipy.stats as stats\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "import matplotlib as mpl\n",
    "import matplotlib.pyplot as plt"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "\n",
       "<style>\n",
       "@media print {\n",
       "    div.prompt_container   { display:none; }\n",
       "    #noprint{ display:none; }\n",
       "    div.notebook-container { border-left: 0px;}\n",
       "    div#notebook-container { border-left: 0px;}\n",
       "    div.code_cell {   \n",
       "    }\n",
       "    .CCodeMirror {\n",
       "        font-family: monospace;\n",
       "        background-color: #cccccc\n",
       "    }\n",
       "    body {\n",
       "        background-color: lightgreen;\n",
       "    }\n",
       "    ddiv.code_cell {    \n",
       "        border: 1px solid silver;\n",
       "        background-color: lightgreen;\n",
       "    }\n",
       "}\n",
       "\n",
       "@media screen{\n",
       "}\n",
       "</style>\n"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "#skip\n",
    "hh='''\n",
    "<style>\n",
    "@media print {\n",
    "    div.prompt_container   { display:none; }\n",
    "    #noprint{ display:none; }\n",
    "    div.notebook-container { border-left: 0px;}\n",
    "    div#notebook-container { border-left: 0px;}\n",
    "    div.code_cell {   \n",
    "    }\n",
    "    .CCodeMirror {\n",
    "        font-family: monospace;\n",
    "        background-color: #cccccc\n",
    "    }\n",
    "    body {\n",
    "        background-color: lightgreen;\n",
    "    }\n",
    "    ddiv.code_cell {    \n",
    "        border: 1px solid silver;\n",
    "        background-color: lightgreen;\n",
    "    }\n",
    "}\n",
    "\n",
    "@media screen{\n",
    "}\n",
    "</style>\n",
    "'''\n",
    "display(HTML(hh))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# T-test, F-test, Hotelling's T-squared distribution\n",
    "\n",
    "The $t$-Test is used to test the null hypothesis that the means of two populations are equal.\n",
    "\n",
    "$H_0: \\mu_1 - \\mu_2 = 0$\n",
    "\n",
    "$H_1: \\mu_1 - \\mu_2 \\neq 0$\n",
    "\n",
    "1. First perform F-test to check if the variances are equal\n",
    "\n",
    "In this page we don't talk about the Hotelling's T-squared test which is a generalization of t-test for multivariate case.\n",
    "\n",
    "\n",
    "\n",
    "\n",
    "### F-test\n",
    "Given two series $x$, $y$ - test if the variances of two population are equal.\n",
    "F-test is easy to conduct. $F-value$ of two series $x$ and $y$ is just the ratio $\\frac{Var(x)}{Var(y)}$ \n",
    "\n",
    "$H_0$ **Null-hypothesis**: Two variances are same\n",
    "\n",
    "$H_a$ **Research hypothesis**: Two variances are different \n",
    "\n",
    "$F$-test is done before t-test to determine if the variance of the two population are different.\n",
    "\n",
    "#### Conditions:\n",
    "* Both random variables are normally distributed\n",
    "* The samples are independent\n",
    "\n",
    "If X and Y have a normal distribution, the F-statistic will have F-distribution with $N_x -1\\ and\\ N_y -1$ degrees of freedom. To define the significance level which corresponds to the value of F-statistic high-precision, F-distribution approximation is used.\n",
    "\n",
    "####Example:\n",
    "<pre>\n",
    "Data: is the number of study hours between male and female\n",
    "\n",
    "Female: 26, 25, 43,34,18,52\n",
    "Male:   23,30,18,25,28\t\t\n",
    "</pre>\n",
    "$H_0$: Two variances are same\n",
    "$H_a$: Two variances differ \n",
    "\n",
    "As you can see from the calculations below: $F$ is 7.373 ( $F_{critical}$ = 6.25 , P = 0.03 for one tail which is less than 5% indicated a significant)\n",
    "\n",
    "$F$ >> $F_{critical}$, therefore we reject null hypothesis and say *\"two vairances are different\"*\n",
    "\n",
    "####  t- test\n",
    "\n",
    "From t-test we get t=1.47260514049 p=0.187258096865.\n",
    "$p >> p_{critical} (0.05)$ therefore we cannot reject the null and state that there is no difference in the mean study hours between male and female"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[26 25 43 34 18 52] [23 30 18 25 28] F = 7.373271889400921 ($F_critical,p)= 6.2560565021608845 0.037888376133341395\n",
      "Equal Variance:  False\n"
     ]
    }
   ],
   "source": [
    "# t- test\n",
    "def ComputeDegreesOfFreedomFor_t_test(x,y, equal_variance = True):\n",
    "    n1 = len(x)\n",
    "    n2 = len(y)\n",
    "    if equal_variance:\n",
    "        return n1 + n2 -2;\n",
    "    s1 = x.var()\n",
    "    s2 = y.var()\n",
    "    num = pow((s1/n1 + s2/n2),2)\n",
    "    den = (pow(s1/n1,2) /(n1 -1)) + (pow(s2/n2,2) /(n2 -1))\n",
    "    ret = num/den;\n",
    "    ret = round(ret)\n",
    "    return ret;\n",
    "\n",
    "def t_critical(alpha, df, tails=1):\n",
    "    t_critical_one_tailed=stats.t.ppf(1-alpha, df);\n",
    "    t_critical_two_tailed=stats.t.ppf(1-alpha/2, df);\n",
    "\n",
    "    if ( tails == 1):\n",
    "        return t_critical_one_tailed;\n",
    "    else:\n",
    "        return t_critical_two_tailed;\n",
    "#       \n",
    "# Returns equal Variance = true if there is no difference in variances\n",
    "#\n",
    "#\n",
    "def Ftest(x,y, alpha = 0.05):\n",
    "    F = x.var()/ y.var();\n",
    "    n1 = len(x);  # degrees of freedom\n",
    "    n2 = len(y);  # degrees of freedom\n",
    "    cl = 1 - alpha; # Confidence Level\n",
    "    F_c = stats.f.ppf(cl, n1 -1 , n2 - 1);  # n1-1, n2-1 are degrees of freedom\n",
    "    p = 1- stats.f.cdf(F, n1 - 1, n2 - 1) \n",
    "\n",
    "    equal_variance = True;\n",
    "    if ( F > F_c ):\n",
    "        equal_variance = False;\n",
    "\n",
    "    ostr =  \"Equal Variance: \" + str(equal_variance) + \\\n",
    "            \", F= \"+ str(F) + \", F_critical=\"+ str(F_c) + \",P=\" + str(p);\n",
    "    return (equal_variance , F, F_c, p, ostr);\n",
    "\n",
    "#\n",
    "# Chi square Critical value \n",
    "def Chi2Critical(df, alpha = 0.05):\n",
    "    cl = 1 - alpha; # Confidence Level\n",
    "    Chi2_c = stats.chi2.ppf(cl, df);\n",
    "    return Chi2_c;\n",
    "\n",
    "\n",
    "a1 = np.array ( \"26, 25, 43,34,18,52,23,30,18,25,28\".split(\",\")).astype(int)\n",
    "a2 = [\"f\"]*6 + [\"m\"]*5;\n",
    "dfL = pd.DataFrame( {\"a1\":a1, \"a2\":a2})\n",
    "\n",
    "#displayDFs(dfL)\n",
    "d1 = dfL.loc[dfL['a2'] == 'f']['a1']\n",
    "d2 = dfL.loc[dfL['a2'] == 'm']['a1']\n",
    "F = d1.var()/ d2.var();\n",
    "F_critical = stats.f.ppf(.95,len(d1) - 1, len(d2) - 1);  # n1 - 1, n2-1 are degrees of freedom\n",
    "p = 1- stats.f.cdf(F,5,4)  # 5 and 4 or len(d1)- 1 and len(d2) -1 \n",
    "\n",
    "print (np.array(d1), np.array(d2), \"F =\", F, \"($F_critical,p)=\", F_critical, p)\n",
    "#\n",
    "# F is >> F_critical and a case for rejecting Null hypothesis\n",
    "#\n",
    "equal_variance = True;  # Null Hypothesis\n",
    "if ( F > F_critical):\n",
    "    equal_variance = False; # Reject the Null Hypothesis\n",
    "    \n",
    "print (\"Equal Variance: \", equal_variance)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Try other tests for the heck of it \n",
    "#print stats.bartlett(d2, d1) \n",
    "#print stats.levene(d2, d1) \n",
    "#stats.f.pdf(F, d1, d2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "1.894578605061305 2.3646242510102993 7\n",
      "1.4726051404930287 0.18725809686523553\n",
      "\n",
      "As p > p_critical of 0.05, we fail to reject the. \n",
      "The observed difference between the sample means (33 - 24.8) \n",
      "is not convincing enough to say that the average number of study hours \n",
      "\n",
      "between female and male students differ significantly. \n",
      "\n"
     ]
    }
   ],
   "source": [
    "t_stat, p = stats.ttest_ind(d1, d2, equal_var=equal_variance)\n",
    "\n",
    "alpha = 0.05;\n",
    "df = ComputeDegreesOfFreedomFor_t_test(d1,d2,equal_variance);\n",
    "t_critical_one_tailed=stats.t.ppf(1-alpha, df);\n",
    "t_critical_two_tailed=stats.t.ppf(1-alpha/2, df);\n",
    "\n",
    "print (t_critical_one_tailed, t_critical_two_tailed, df)\n",
    "print( t_stat, p )\n",
    "\n",
    "print ('''\n",
    "As p > p_critical of 0.05, we fail to reject the. \n",
    "The observed difference between the sample means (33 - 24.8) \n",
    "is not convincing enough to say that the average number of study hours \n",
    "\n",
    "between female and male students differ significantly. \n",
    "''')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "one-sample t-test: p_value =  0.018137235176105812 \n",
      "# daily intake of energy in kJ for 11 women\n",
      "daily_intake = np.array([5260,5470,5640,6180,6390,6515,6805,7515,7515,8230,8770])\n",
      "\n",
      "# Conducting: one sample t-test\n",
      "# null hypothesis: expected value = 7725\n",
      "\n",
      "# p_value < 0.05 => alternative hypothesis:\n",
      "# data deviate significantly from the hypothesis that the mean\n",
      "# is 7725 at the 5% level of significance\n",
      "\n",
      "\n",
      "one-sample wilcoxon-test 0.0244140625\n",
      "========================\n",
      "Example 2: two-sample t-test, p_value= 0.0007989982111700593\n",
      "two-sample wilcoxon-test p_value= 0.0010608066929400244\n",
      "========================\n",
      "Example 3: paired t-test p_value= 3.059020942934875e-07\n",
      "paired wilcoxon-test p_value= 0.0009765625\n"
     ]
    }
   ],
   "source": [
    "# Another set of examples I found at: https://gist.github.com/mblondel/1761714\n",
    "# from scipy.stats import ttest_1samp, wilcoxon, ttest_ind, mannwhitneyu\n",
    "#=======================================================================\n",
    "# EXAMPLE 1.\n",
    "# one sample t-test\n",
    "# null hypothesis: expected value = 7725\n",
    "\n",
    "# daily intake of energy in kJ for 11 women\n",
    "daily_intake = np.array([5260,5470,5640,6180,6390,6515,6805,7515,7515,8230,8770])\n",
    "\n",
    "t_statistic, p_value = stats.ttest_1samp(daily_intake, 7725)\n",
    "\n",
    "\n",
    "print (\"one-sample t-test: p_value = \", p_value , '''\n",
    "# daily intake of energy in kJ for 11 women\n",
    "daily_intake = np.array([5260,5470,5640,6180,6390,6515,6805,7515,7515,8230,8770])\n",
    "\n",
    "# Conducting: one sample t-test\n",
    "# null hypothesis: expected value = 7725\n",
    "\n",
    "# p_value < 0.05 => alternative hypothesis:\n",
    "# data deviate significantly from the hypothesis that the mean\n",
    "# is 7725 at the 5% level of significance\n",
    "\n",
    "''')\n",
    "# one sample wilcoxon-test\n",
    "wz_statistic, wp_value = stats.wilcoxon(daily_intake - 7725)\n",
    "print (\"one-sample wilcoxon-test\", wp_value)\n",
    "#=======================================================================\n",
    "# EXAMPLE 2.\n",
    "\n",
    "# two-sample t-test\n",
    "# null hypothesis: the two groups have the same mean\n",
    "# this test calls F test to check if equal variance can be assumed\n",
    "# independent groups: e.g., how boys and girls fare at an exam\n",
    "# dependent groups: e.g., how the same class fare at 2 different exams\n",
    "\n",
    "energ = np.array([\n",
    "# energy expenditure in mJ and stature (0=obese, 1=lean)\n",
    "[9.21, 0],[7.53, 1],[7.48, 1],[8.08, 1],[8.09, 1],[10.15,1],[8.40, 1],[10.88, 1],\n",
    "[6.13, 1],[7.90, 1],[11.51,0],[12.79,0],[7.05, 1],[11.85,0],[9.97, 0],[7.48,  1],\n",
    "[8.79, 0],[9.69, 0],[9.68, 0],[7.58, 1],[9.19, 0],[8.11, 1]]\n",
    ")\n",
    "\n",
    "# similar to expend ~ stature in R\n",
    "group1 = energ[:, 1] == 0\n",
    "group1 = energ[group1][:, 0]\n",
    "group2 = energ[:, 1] == 1\n",
    "group2 = energ[group2][:, 0]\n",
    "(equal_variance, F , F_c , p,d) = Ftest(group1, group2)\n",
    "t_statistic, p_value = stats.ttest_ind(group1, group2,  equal_var=equal_variance)\n",
    "\n",
    "# p_value (0.00079) < 0.05 => alt hypothesis: Mean value differ 5% significance level\n",
    "print (\"========================\\nExample 2: two-sample t-test, p_value=\", p_value)\n",
    "\n",
    "# two-sample wilcoxon test\n",
    "# a.k.a Mann Whitney U\n",
    "u, p_value = stats.mannwhitneyu(group1, group2)\n",
    "print (\"two-sample wilcoxon-test p_value=\", p_value)\n",
    "\n",
    "#=======================================================================\n",
    "# EXAMPLE 3\n",
    "# pre and post-menstrual energy intake\n",
    "intake = np.array([\n",
    "[5260, 3910],[5470, 4220],[5640, 3885],[6180, 5160],[6390, 5645],[6515, 4680],\n",
    "[6805, 5265],[7515, 5975],[7515, 6790],[8230, 6900],[8770, 7335],\n",
    "])\n",
    "\n",
    "pre = intake[:, 0]\n",
    "post= intake[:, 1]\n",
    "\n",
    "# paired t-test: doing two measurments on the same experimental unit\n",
    "# e.g., before and after a treatment\n",
    "t_statistic, p_value = stats.ttest_1samp(post - pre, 0)\n",
    "\n",
    "# p < 0.05 => alternative hypothesis:\n",
    "# the difference in mean is not equal to 0\n",
    "print (\"========================\\nExample 3: paired t-test p_value=\", p_value)\n",
    "\n",
    "# alternative to paired t-test when data has an ordinary scale or when not\n",
    "# normally distributed\n",
    "z_statistic, p_value = stats.wilcoxon(post - pre)\n",
    "\n",
    "print (\"paired wilcoxon-test p_value=\", p_value)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "(True,\n",
       " 1.2275707804649485,\n",
       " 2.848565142067682,\n",
       " 0.3612456947013797,\n",
       " 'Equal Variance: True, F= 1.2275707804649485, F_critical=2.848565142067682,P=0.3612456947013797')"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#skip\n",
    "#%run  \"../StatUtils.py\"\n",
    "(eq,a,b,c,d) = Ftest(group1, group2)\n",
    "(eq,a,b,c,d)"
   ]
  }
 ],
 "metadata": {
  "hide_input": false,
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.3"
  },
  "toc": {
   "base_numbering": 1,
   "nav_menu": {},
   "number_sections": true,
   "sideBar": true,
   "skip_h1_title": false,
   "title_cell": "Table of Contents",
   "title_sidebar": "Contents",
   "toc_cell": false,
   "toc_position": {},
   "toc_section_display": true,
   "toc_window_display": false
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
